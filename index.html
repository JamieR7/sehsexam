<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IB SEHS Exam Practice</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #004587;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 70px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.95; }
        .ai-disclaimer {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
        .ai-disclaimer strong { display: block; margin-bottom: 5px; font-size: 15px; }
        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .level-toggle { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .level-btn {
            padding: 10px 30px;
            border: 2px solid #F2B406;
            background: white;
            color: #F2B406;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .level-btn.active { background: #F2B406; color: white; }
        .level-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .filter-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (max-width: 768px) { .filter-grid { grid-template-columns: 1fr; } }
        .filter-section label { display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px; }
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        select:hover { border-color: #F2B406; }
        select:focus { outline: none; border-color: #F2B406; }
        select:disabled { background: #f5f5f5; opacity: 0.6; cursor: not-allowed; }
        .question-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }
        .nav-btn {
            padding: 10px 20px;
            background: #F2B406;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .nav-btn:hover:not(:disabled) { background: #E82F37; }
        .nav-btn:disabled { background: #ccc; cursor: not-allowed; }
        .random-btn {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.3s;
        }
        .random-btn:hover { background: #059669; }

.dontknow-btn {
            width: 100%;
            padding: 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dontknow-btn:hover {
            transform: translateY(-2px);
            background: #5a6268;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        .honesty-message {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            color: #0c5460;
            line-height: 1.6;
        }
        .honesty-message h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        .revisit-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            color: #856404;
            font-weight: 600;
            text-align: center;
        }
        
        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-right: 8px;
            letter-spacing: 0.5px;
        }
        .badge-SL { background: #10b981; color: white; }
        .badge-HL { background: #f59e0b; color: white; }
        .subtopic-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
            background: #e0e7ff;
            color: #3730a3;
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .marks-badge {
            background: #F2B406;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        .question-text { font-size: 18px; line-height: 1.6; color: #1a1a1a; margin-bottom: 25px; }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }
        textarea:focus { outline: none; border-color: #F2B406; }
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #F2B406 0%, #F2B406 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .loading { text-align: center; color: #F2B406; font-weight: 600; margin-top: 15px; display: none; }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #F2B406;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .result { margin-top: 20px; padding: 20px; border-radius: 8px; display: none; }
        .score-display { font-size: 24px; font-weight: bold; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
        .comment-section, .hint-section { margin-top: 20px; padding: 15px; border-radius: 6px; }
        .comment-section h3, .hint-section h3 { font-size: 14px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .comment-section p, .hint-section p { margin: 0; line-height: 1.6; }
        .mark-scheme-section { margin-top: 20px; padding: 15px; border-radius: 6px; background: #f8f9fa; border-left: 4px solid #6c757d; }
        .mark-scheme-section h3 { font-size: 14px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; color: #495057; }
        .mark-scheme-section p { line-height: 1.8; }
        
        .progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 55px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
        }
        .progress-wrapper {
            flex: 1;
            position: relative;
            height: 28px;
            background: #ffffff;
            border-radius: 14px;
            overflow: visible;
            border: 2px solid #f0f0f0;
            z-index: 1;
        }
        .progress-fill {
            height: 100%;
            background: #ff8c00;
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
            z-index: 2;
        }
        .progress-checkmarks {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            pointer-events: none;
            z-index: 3;
        }
        .checkpoint {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #666;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s;
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            pointer-events: all;
            cursor: help;
            z-index: 4;
        }
        .checkpoint.achieved {
            background: #10b981;
            border-color: #10b981;
            color: white;
            font-weight: bold;
        }
        .checkpoint:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            font-weight: 600;
            z-index: 10;
            pointer-events: none;
        }
        .checkpoint:hover::before {
            content: '';
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            z-index: 10;
        }
        .you-marker {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: left 0.5s ease;
            z-index: 3;
        }
        .you-dot {
            width: 14px;
            height: 14px;
            background: #ff8c00;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(255, 140, 0, 0.6);
        }
        .you-label {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff8c00;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            white-space: nowrap;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .progress-text {
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            color: #004587;
            font-size: 16px;
            white-space: nowrap;
            min-width: 280px;
            letter-spacing: -0.02em;
        }
        .progress-text .points-display {
            font-size: 22px;
            color: #F2B406;
            font-weight: 500;
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .milestone-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 2000;
            text-align: center;
            transition: transform 0.3s;
        }
        .milestone-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }
        .milestone-popup .emoji {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .milestone-popup .title {
            font-size: 24px;
            font-weight: bold;
            color: #F2B406;
            margin-bottom: 10px;
            font-family: 'Gotham', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
    <script src="allQuestions.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ IB SEHS Exam Practice</h1>
            <p>Exam questions with instant(ish) AI marking & feedback</p>
        </div>

        <div class="ai-disclaimer">
            <strong>‚ö†Ô∏è AI Marking Disclaimer</strong>
            Watch out! This marking is done by AI. It's usually pretty good, but just like your teacher, it is occasionally clueless! Think you should have been given more marks? Perfect! That's critical thinking at work. Bring your disagreement to your teacher and classmates for some proper academic debate. The official IB mark schemes are still the final word.
        </div>

        <div class="controls">
            <div class="level-toggle">
                <button class="level-btn active" data-level="SL" onclick="setLevel('SL')">Standard Level (SL)</button>
                <button class="level-btn" data-level="HL" onclick="setLevel('HL')">Higher Level (HL)</button>
            </div>

            <div class="filter-grid">
                <div class="filter-section">
                    <label for="sectionFilter">Section:</label>
                    <select id="sectionFilter" onchange="updateTopics()">
                        <option value="">All Sections</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="topicFilter">Topic:</label>
                    <select id="topicFilter" onchange="updateSubtopics()">
                        <option value="">All Topics</option>
                    </select>
                </div>

                <div class="filter-section">
                    <label for="subtopicFilter">Sub-topic:</label>
                    <select id="subtopicFilter" onchange="filterQuestions()">
                        <option value="">All Sub-topics</option>
                    </select>
                </div>
            </div>

            <div class="question-nav">
                <button class="nav-btn" id="prevBtn" onclick="navigateQuestion(-1)">‚Üê Previous</button>
                <button class="random-btn" onclick="loadRandomQuestion()">üé≤ Random</button>
                <button class="nav-btn" id="nextBtn" onclick="navigateQuestion(1)">Next ‚Üí</button>
            </div>
        </div>

        <div class="card">
            <div id="questionDisplay"></div>
            <textarea id="answerInput" placeholder="Type your answer here..."></textarea>
            <button class="submit-btn" onclick="submitAnswer()">Submit Answer</button>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Marking your answer...
            </div>
            <div class="result" id="result"></div>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="progress-bar-container">
        <div class="progress-wrapper">
            <div class="progress-fill" id="progressFill"></div>
            <div class="progress-checkmarks">
                <div class="checkpoint" style="left: 5%;" data-points="5" data-tooltip="5 pts: No longer clueless ü§∑‚Äç‚ôÇÔ∏è"></div>
                <div class="checkpoint" style="left: 10%;" data-points="10" data-tooltip="10 pts: Getting the vibe üéØ"></div>
                <div class="checkpoint" style="left: 20%;" data-points="20" data-tooltip="20 pts: On a streak üî•"></div>
                <div class="checkpoint" style="left: 35%;" data-points="35" data-tooltip="35 pts: Built different üí™"></div>
                <div class="checkpoint" style="left: 50%;" data-points="50" data-tooltip="50 pts: Actually goated üêê"></div>
                <div class="checkpoint" style="left: 75%;" data-points="75" data-tooltip="75 pts: Certified legend üëë"></div>
                <div class="checkpoint" style="left: 100%;" data-points="100" data-tooltip="100 pts: Final boss down ‚öîÔ∏è"></div>
            </div>
            <div class="you-marker" id="youMarker">
                <div class="you-dot"></div>
                <div class="you-label">You</div>
            </div>
        </div>
        <div class="progress-text" id="progressText"><span class="points-display">0</span> pts ¬∑ Next: No longer clueless ü§∑‚Äç‚ôÇÔ∏è (5 away)</div>
    </div>

    <!-- Milestone Popup -->
    <div class="milestone-popup" id="milestonePopup">
        <div class="emoji" id="milestoneEmoji"></div>
        <div class="title" id="milestoneTitle"></div>
    </div>

    <script>
        let currentQuestion = null;
        let filteredQuestions = [];
        let currentIndex = 0;
        let currentLevel = 'SL';
        let totalPoints = 0;
        let attemptCount = 0;
        let questionAttempts = {};
        let milestones = {5: {emoji: 'ü§∑‚Äç‚ôÇÔ∏è', title: 'No longer clueless'}, 10: {emoji: 'üéØ', title: 'Getting the vibe'}, 20: {emoji: 'üî•', title: 'On a streak'}, 35: {emoji: 'üí™', title: 'Built different'}, 50: {emoji: 'üêê', title: 'Actually goated'}, 75: {emoji: 'üëë', title: 'Certified legend'}, 100: {emoji: '‚öîÔ∏è', title: 'Final boss down'}};

        const curriculum = {
            "A": { 
                "name": "Exercise physiology and nutrition",
                "topics": {
                    "A.1": { name: "Communication", subtopics: ["A.1.1 Inter-system communication", "A.1.2 Maintaining homeostasis", "A.1.3 Transport"] },
                    "A.2": { name: "Hydration and nutrition", subtopics: ["A.2.1 Water and electrolyte balance", "A.2.2 Fuelling for health and performance", "A.2.3 Energy systems"] },
                    "A.3": { name: "Response", subtopics: ["A.3.1 Qualities of training", "A.3.2 Benefits of health of being active", "A.3.3 Fatigue and recovery"] }
                }
            },
            "B": { 
                "name": "Biomechanics",
                "topics": {
                    "B.1": { name: "Generating movement in the body", subtopics: ["B.1.1 Anatomical position, planes and movement", "B.1.2 Structure and function of connective tissues and joints", "B.1.3 Muscular function", "B.1.4 Levers in movement and sport"] },
                    "B.2": { name: "Forces, motion and movement", subtopics: ["B.2.1 Newton's laws of motion", "B.2.2 Fluid mechanics", "B.2.3 Movement analysis and its applications"] },
                    "B.3": { name: "Injury", subtopics: ["B.3.1 Causes of injury", "B.3.2 Interventions related to injury"] }
                }
            },
            "C": { 
                "name": "Sports psychology and motor learning",
                "topics": {
                    "C.1": { name: "Individual differences", subtopics: ["C.1.1 Personality", "C.1.2 Mental toughness"] },
                    "C.2": { name: "Motor learning", subtopics: ["C.2.1 Motor learning processes", "C.2.2 Attentional control"] },
                    "C.3": { name: "Motivation", subtopics: ["C.3.1 Achievement motivation", "C.3.2 Self-determination", "C.3.3 Motivational climate"] },
                    "C.4": { name: "Stress and coping", subtopics: ["C.4.1 Arousal and anxiety", "C.4.2 Coping"] },
                    "C.5": { name: "Psychological skills", subtopics: ["C.5.1 Goal setting", "C.5.2 Imagery"] }
                }
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            if (window.allQuestions && window.allQuestions.length > 0) {
                populateFilters();
                filterQuestions();
            } else {
                console.error('allQuestions not loaded from allQuestions.js');
            }
        });

        function populateFilters() {
            const sections = [...new Set(window.allQuestions.map(q => q.section))].sort();
            const sectionFilter = document.getElementById('sectionFilter');
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section;
                option.textContent = section + ' - ' + (curriculum[section]?.name || '');
                sectionFilter.appendChild(option);
            });
        }

        function updateTopics() {
            const section = document.getElementById('sectionFilter').value;
            const topicFilter = document.getElementById('topicFilter');
            const subtopicFilter = document.getElementById('subtopicFilter');
            topicFilter.innerHTML = '<option value="">All Topics</option>';
            subtopicFilter.innerHTML = '<option value="">All Sub-topics</option>';

            if (!section) {
                filterQuestions();
                return;
            }

            const topics = curriculum[section]?.topics || {};
            Object.keys(topics).forEach(topicCode => {
                const option = document.createElement('option');
                option.value = topicCode;
                option.textContent = topicCode + ' - ' + topics[topicCode].name;
                topicFilter.appendChild(option);
            });

            filterQuestions();
        }

        function updateSubtopics() {
            const section = document.getElementById('sectionFilter').value;
            const topic = document.getElementById('topicFilter').value;
            const subtopicFilter = document.getElementById('subtopicFilter');
            subtopicFilter.innerHTML = '<option value="">All Sub-topics</option>';

            if (!topic) {
                filterQuestions();
                return;
            }

            const subtopics = curriculum[section]?.topics[topic]?.subtopics || [];
            subtopics.forEach(subtopic => {
                const option = document.createElement('option');
                option.value = subtopic;
                option.textContent = subtopic;
                subtopicFilter.appendChild(option);
            });

            filterQuestions();
        }

        function setLevel(level) {
            currentLevel = level;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            filterQuestions();
        }

        function filterQuestions() {
            const section = document.getElementById('sectionFilter').value;
            const topic = document.getElementById('topicFilter').value;
            const subtopic = document.getElementById('subtopicFilter').value;

            filteredQuestions = window.allQuestions.filter(q => {
                if (currentLevel && q.level !== currentLevel) return false;
                if (section && q.section !== section) return false;
                if (topic && !q.subtopic.startsWith(topic)) return false;
                if (subtopic) {
                    const cleanSubtopic = subtopic.split(' ')[0];
                    const qSubtopicCode = q.subtopic.split(' ')[0];
                    if (qSubtopicCode !== cleanSubtopic) return false;
                }
                return true;
            });

            currentIndex = 0;
            if (filteredQuestions.length === 0) {
                document.getElementById('questionDisplay').innerHTML = '<p>No questions found.</p>';
            } else {
                displayQuestion(filteredQuestions[currentIndex]);
            }
        }

        function displayQuestion(question) {
            currentQuestion = question;
            document.getElementById('answerInput').value = '';
            document.getElementById('result').style.display = 'none';

            const html = `
                <div class="question-header">
                    <div>
                        <span class="level-badge badge-${question.level}">${question.level}</span>
                        <span class="subtopic-badge">${question.subtopic}</span>
                    </div>
                    <span class="marks-badge">[${question.marks} marks]</span>
                </div>
                <p class="question-text">${question.question}</p>
            `;
            document.getElementById('questionDisplay').innerHTML = html;
            updateNavButtons();
        }

        function navigateQuestion(direction) {
            currentIndex += direction;
            if (currentIndex < 0) currentIndex = 0;
            if (currentIndex >= filteredQuestions.length) currentIndex = filteredQuestions.length - 1;
            displayQuestion(filteredQuestions[currentIndex]);
        }

        function loadRandomQuestion() {
            currentIndex = Math.floor(Math.random() * filteredQuestions.length);
            displayQuestion(filteredQuestions[currentIndex]);
        }

        function updateNavButtons() {
            document.getElementById('prevBtn').disabled = currentIndex === 0;
            document.getElementById('nextBtn').disabled = currentIndex === filteredQuestions.length - 1;
        }

        async function submitAnswer() {
            const answerText = document.getElementById('answerInput').value.trim();

            if (!answerText) {
                alert('Please type an answer before submitting.');
                return;
            }

            if (!currentQuestion) return;

            // Track attempts per question
            if (!questionAttempts[currentQuestion.id]) {
                questionAttempts[currentQuestion.id] = 0;
            }
            questionAttempts[currentQuestion.id]++;
            const currentAttempt = questionAttempts[currentQuestion.id];

            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';

            try {
                const body = {
                    questionId: currentQuestion.id,
                    question: currentQuestion.question,
                    markScheme: currentQuestion.markScheme,
                    maxMarks: currentQuestion.marks,
                    answer: answerText,
                    attemptNumber: currentAttempt,
                };

                const response = await fetch('https://sehsexam.thatjamiebloke.workers.dev/mark', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                const data = await response.json();

                if (data.error) {
                    displayResult({
                        score: 0,
                        maxMarks: currentQuestion.marks,
                        strengths: 'Could not mark answer',
                        improvements: data.error,
                        studyTip: 'Please try again',
                        markScheme: currentQuestion.markScheme,
                        currentAttempt: currentAttempt
                    });
                } else {
                    displayResult({
                        score: data.score,
                        maxMarks: currentQuestion.marks,
                        strengths: data.strengths,
                        improvements: data.improvements,
                        studyTip: data.studyTip,
                        markScheme: currentQuestion.markScheme,
                        currentAttempt: currentAttempt
                    });

                    const oldPoints = totalPoints;
                    totalPoints += data.score;
                    updateProgressBar();
                    
                    // Check for milestone
                    Object.keys(milestones).forEach(pts => {
                        if (oldPoints < pts && totalPoints >= pts) {
                            showMilestone(pts);
                        }
                    });
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                document.getElementById('result').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');
            const percentage = Math.round((data.score / data.maxMarks) * 100);

            // Format mark scheme with line breaks after ticks
            const formattedMarkScheme = data.markScheme
                .split('‚úì')
                .map((part, index) => {
                    if (index === 0) return part.trim();
                    return (part.trim() ? '‚úì ' + part.trim() : '');
                })
                .filter(line => line.length > 0)
                .join('<br>');

            let html = `
                <div class="score-display">
                    Score: ${data.score}/${data.maxMarks} (${percentage}%)
                </div>
                <div class="comment-section" style="background: #e8f5e9; border-left-color: #10b981;">
                    <h3>‚úÖ Strengths</h3>
                    <p>${data.strengths}</p>
                </div>
                <div class="comment-section" style="background: #fff3e0; border-left-color: #f59e0b;">
                    <h3>üìù Areas to Improve</h3>
                    <p>${data.improvements}</p>
                </div>
                <div class="hint-section" style="background: #e3f2fd; border-left-color: #2196F3;">
                    <h3>üí° Study Tip</h3>
                    <p>${data.studyTip}</p>
                </div>
            `;

            // Only show mark scheme on second attempt or later
            if (data.currentAttempt >= 2) {
                html += `
                <div class="mark-scheme-section">
                    <h3>üìã Official Mark Scheme</h3>
                    <p>${formattedMarkScheme}</p>
                </div>
                `;
            } else {
                html += `
                <div class="mark-scheme-section">
                    <h3>üìã Official Mark Scheme</h3>
                    <p><em>Try again to see the mark scheme! üëÄ</em></p>
                </div>
                `;
            }

            resultDiv.innerHTML = html;
            resultDiv.style.display = 'block';
        }

        function updateProgressBar() {
            const percentage = (totalPoints / 200) * 100;
            document.getElementById('progressFill').style.width = Math.min(percentage, 100) + '%';
            document.getElementById('progressText').querySelector('.points-display').textContent = totalPoints;

            const checkpoints = document.querySelectorAll('.checkpoint');
            let nextMilestone = null;
            checkpoints.forEach(cp => {
                const points = parseInt(cp.getAttribute('data-points'));
                if (totalPoints >= points) {
                    cp.classList.add('achieved');
                } else {
                    cp.classList.remove('achieved');
                    if (!nextMilestone) nextMilestone = points;
                }
            });

            if (nextMilestone) {
                const away = nextMilestone - totalPoints;
                document.getElementById('progressText').innerHTML = `<span class="points-display">${totalPoints}</span> pts ¬∑ Next: ${milestones[nextMilestone]?.emoji} ${milestones[nextMilestone]?.title} (${away} away)`;
            } else {
                document.getElementById('progressText').innerHTML = `<span class="points-display">${totalPoints}</span> pts ¬∑ You're a legend! üëë`;
            }

            const youMarker = document.getElementById('youMarker');
            youMarker.style.left = Math.min(percentage, 100) + '%';
        }

        function showMilestone(points) {
            const milestone = milestones[points];
            document.getElementById('milestoneEmoji').textContent = milestone.emoji;
            document.getElementById('milestoneTitle').textContent = milestone.title;
            const popup = document.getElementById('milestonePopup');
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>
